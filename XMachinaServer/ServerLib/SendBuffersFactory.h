#pragma once

/// +-----------------------------------------------
///					 SendBuffersFactory 
/// ________________________________________________
/// 
/// SendPktBuf  ( SLIST )
/// ________________________________________________
/// 
/// 각 Thread 별로 SendBufferFactory 를 소유하고 있다. ( TLS ) 
/// Variable Length PktBuf				
/// [32] [64] [128] [256] [512]
/// [32] [64] [128] [256] [512]
/// ...  ...  ...   ...   ...
/// [32] [64] [128] [256] [512] 
/// ________________________________________________
/// Fixed Length PktBuf
/// 
/// 
/// - TLS 영역에 생성시킬것이기에 싱글쓰레드처럼 사용가능
/// -----------------------------------------------+


namespace SendPktInfo {
	enum class Type {
		Variable_Length, // 가변 길이 Send Packet 
		Fixed_Length	 // 고정 길이 Send Packet 
	};

	/* Variable - 크기에 맞는 바이트 메모리 풀에 가변길이 데이터를 Write */
	enum class Var : UINT8 {
		BYTES_32,
		BYTES_64,
		BYTES_128,
		BYTES_256,
		BYTES_512,
	};
	/* Fixed */
	enum class Fix : UINT8 {
		LogIn,
		Transform,

		// ... 
	};

	constexpr UINT16 MemoryNum = 100;
}


// 각 쓰레드 마다 하나씩 생성 시킬 것 ( 안전하게 shared_ptr 로 생성 )
class SendBuffersFactory : public std::enable_shared_from_this<SendBuffersFactory>
{
	USE_LOCK;
private:
	std::unordered_map<SendPktInfo::Var, class SListMemoryPool*> mMemPools_VarPkt = {}; // 가변길이 패킷 전용 메모리 풀 
	std::unordered_map<SendPktInfo::Fix, class SListMemoryPool*> mMemPools_FixPkt = {}; // 고정길이 패킷 전용 메모리 풀 

public:
	SendBuffersFactory();
	~SendBuffersFactory();

public:
	void InitPacketMemoryPools();

public:
	/* 메모리 풀에서 메모리를 가져온다. */ 
	void* Pull_VarPkt(size_t memorySize);
	void* Pull_FixPkt(SendPktInfo::Fix type);

	/*  메모리 풀에 메모리를 반납한다. */
	void  Push_VarPkt(size_t memorySize, void* ptr);
	void  Push_FixPkt(SendPktInfo::Fix type, void* ptr); 

	SPtr_SendPktBuf CreateVarSendPacketBuf(size_t memorySize);
	SPtr_SendPktBuf CreateFixSendPacketBuf(SendPktInfo::Fix pktDataType);


public:
	static PacketSendBuf* New(SendBuffersFactory* factory, BYTE* buffer, UINT32 allocSize);
	template<typename Type>
	static void Delete(Type* ptr);
	
	std::shared_ptr<PacketSendBuf> Make_Shared(SendBuffersFactory* factory, BYTE* buffer, UINT32 allocSize);

};

template<typename Type>
inline void SendBuffersFactory::Delete(Type* ptr)
{
	ptr->~Type();
}

inline PacketSendBuf* SendBuffersFactory::New(SendBuffersFactory* factory, BYTE* buffer, UINT32 allocSize)
{
	PacketSendBuf* Memory = static_cast<PacketSendBuf*>(static_cast<void*>(buffer));
	new(Memory)PacketSendBuf(buffer, allocSize); /* Placement New */
	return Memory;;
}

inline std::shared_ptr<PacketSendBuf> SendBuffersFactory::Make_Shared(SendBuffersFactory* factory, BYTE* buffer, UINT32 allocSize)
{
	return std::shared_ptr<PacketSendBuf>{ SendBuffersFactory::New(factory,buffer, allocSize), SendBuffersFactory::Delete<PacketSendBuf>};
}
